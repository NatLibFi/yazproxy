# Build yazproxy
name: Build yazproxy
on: [push, pull_request]
jobs:
 build:
  runs-on: ubuntu-latest
  steps:
   - uses: actions/checkout@v5
     with:
      fetch-depth: 1
   - name: Clone YAZ
     uses: actions/checkout@v5
     with:
      repository: indexdata/yaz
      path: yaz
      ref: master
   - name: Clone YAZPP
     uses: actions/checkout@v5
     with:
      repository: indexdata/yazpp
      path: yazpp
      ref: master
   - name: Update packages
     run: sudo apt update
   - name: Install required and optional dependencies
     run: >
      sudo apt install autoconf automake libtool gcc g++ make bison
      tclsh xsltproc docbook docbook-xml docbook-xsl
      pkg-config libxslt1-dev libgnutls28-dev libicu-dev libgtest-dev
   - name: Run buildconf for YAZ
     run: cd yaz && ./buildconf.sh
   - name: Run configure for YAZ
     run: >
      cd yaz && ./configure --disable-shared --enable-static
   - name: Run make for YAZ
     run: cd yaz && make -j4
   - name: Run buildconf for YAZ++
     run: cd yazpp && ./buildconf.sh
   - name: Run configure for YAZ++
     run: >
      cd yazpp && ./configure --with-yaz=../yaz
      --disable-shared --enable-static
   - name: Run make for YAZ++
     run: cd yazpp && make -j4
   - name: Run buildconf for yazproxy
     run: ./buildconf.sh
   - name: Run configure for yazproxy
     run: >
      ./configure --with-yazpp=yazpp --disable-shared --enable-static
   - name: Run make check for yazproxy
     run: make -j4 check

 quayio:
  name: Quay.io image webhook
  runs-on: ubuntu-latest

  steps:
  - uses: actions/checkout@v5
    with:
      fetch-depth: 1
  - name: Build Image
    id: build-image
    uses: redhat-actions/buildah-build@v2
    with:
     image: yazproxy
     tags: ipv6 ${{ github.sha }}
     containerfiles: |
      ./Dockerfile

  # Podman Login action (https://github.com/redhat-actions/podman-login) also be used to log in,
  # in which case 'username' and 'password' can be omitted.
  - name: Push To quay.io
    id: push-to-quay
    uses: redhat-actions/push-to-registry@v2
    with:
     image: ${{ steps.build-image.outputs.image }}
     tags: "ipv6"
     registry: quay.io/natlibfi
     username: ${{ secrets.MELINDA_QUAY_IO_USERNAME }}
     password: ${{ secrets.MELINDA_QUAY_IO_PASSWORD }}
